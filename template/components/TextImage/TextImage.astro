---
import './TextImage.css';
import { DBTag } from '@db-ux/react-core-components';

interface Props {
  title?: string;
  imageSrc: string;
  imageAlt: string;
  imageSrcDark?: string;
  reversed?: boolean;
  contentAlign?: 'start' | 'center' | 'end';
  headlineLevel?: 1 | 2 | 3 | 4 | 5 | 6;
  imageWidth?: '50' | '33' | '66';
  layout?: 'horizontal' | 'vertical';
  imagePosition?: 'top' | 'bottom' | 'left' | 'right';
  mask?:
    | 'fade-right'
    | 'fade-left'
    | 'fade-top'
    | 'fade-bottom'
    | 'fade-bottom-right'
    | 'fade-bottom-left'
    | 'fade-top-right'
    | 'fade-top-left';
  rounded?: boolean;
  textGap?: 'sm' | 'md' | 'lg' | 'xl' | '2xl' | '3xl';
  tag?: { label: string; emphasis?: 'strong' | 'weak' | 'default' };
}

const {
  title,
  imageSrc,
  imageAlt,
  imageSrcDark,
  imagePosition = 'right',
  contentAlign = 'center',
  imageWidth = '66',
  mask,
  rounded = false,
  textGap = 'sm',
  headlineLevel = 4,
  tag,
} = Astro.props as Props;

// Headline stets h6 â€“ Typografie kommt aus globalen Styles
---

<div
  class="text-image"
  data-image-position={imagePosition}
  data-image-width={imageWidth}
  data-content-align={contentAlign}
  data-text-gap={textGap}
>
  <div class="text-image__content">
    {
      tag && (
        <div class="text-image__tag" data-density="functional">
          <DBTag emphasis={tag.emphasis === 'default' ? undefined : tag.emphasis}>
            {tag.label}
          </DBTag>
        </div>
      )
    }
    {
      title &&
        (headlineLevel === 1 ? (
          <h1 class="text-image__title">{title}</h1>
        ) : headlineLevel === 2 ? (
          <h2 class="text-image__title">{title}</h2>
        ) : headlineLevel === 3 ? (
          <h3 class="text-image__title">{title}</h3>
        ) : headlineLevel === 4 ? (
          <h4 class="text-image__title">{title}</h4>
        ) : headlineLevel === 5 ? (
          <h5 class="text-image__title">{title}</h5>
        ) : (
          <h6 class="text-image__title">{title}</h6>
        ))
    }
    <div class="text-image__text">
      <slot />
    </div>
  </div>
  <div class="text-image__image">
    <img
      src={imageSrc}
      alt={imageAlt}
      loading="lazy"
      data-mask={mask}
      data-rounded={rounded ? 'true' : undefined}
      data-image-src={imageSrc}
      data-image-src-dark={imageSrcDark}
    />
  </div>
</div>
<script>
  // sync image with the current color mode.
  if (typeof window !== 'undefined') {
    const shell = document.querySelector('.db-shell');
    const images = document.querySelectorAll<HTMLImageElement>(
      '.text-image__image img[data-image-src]',
    );

    if (shell && images.length > 0) {
      const applyMode = (mode: string | null) => {
        images.forEach((img) => {
          const light = img.dataset.imageSrc;
          const dark = img.dataset.imageSrcDark;
          if (mode === 'dark' && dark) {
            img.src = dark;
          } else if (light) {
            img.src = light;
          }
        });
      };

      applyMode(shell.getAttribute('data-mode'));

      const observer = new MutationObserver((mutations) => {
        for (const m of mutations) {
          if (m.type === 'attributes' && m.attributeName === 'data-mode') {
            applyMode(shell.getAttribute('data-mode'));
          }
        }
      });

      observer.observe(shell, { attributes: true, attributeFilter: ['data-mode'] });
    }
  }
</script>
