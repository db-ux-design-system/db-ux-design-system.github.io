---
import { DBButton, DBCard } from "@db-ux/react-core-components";

const items = Array.isArray(Astro.props.items) ? Astro.props.items : [];
const initialId = Astro.props.initialId;
const initialItem = (initialId && items.find((i) => i.id === initialId)) ?? items[0] ?? null;
---

{items.length === 0 || !initialItem ? null : (
  <div data-image-toggle-root>
    {items.map((item) => {
        return (
          <DBButton
            icon={item.icon}
            data-image-toggle-button
            data-image-id={item.id}
            data-image-src={item.src}
            data-image-alt={item.alt ?? item.label}
          >
            {item.label}
          </DBButton>
        );
      })}

      <img
        data-image-toggle-target
        src={initialItem.src}
        alt={initialItem.alt ?? initialItem.label}
      />
  </div>
)}

<script>
    const initializedRoots = new WeakSet<Element>();

    const initRoot = (root: Element) => {
      if (initializedRoots.has(root)) return;
      initializedRoots.add(root);

      const buttons = root.querySelectorAll("[data-image-toggle-button]");
      const img = root.querySelector("[data-image-toggle-target]") as HTMLImageElement | null;

      buttons.forEach((button) => {
        button.addEventListener("click", () => {
          const src = button.getAttribute("data-image-src");
          const alt = button.getAttribute("data-image-alt") ?? "";
          img.setAttribute("src", src);
          img.setAttribute("alt", alt);
        });
      });
    };

    const scanRoots = () => {
      const roots = document.querySelectorAll("[data-image-toggle-root]");
      roots.forEach((root) => initRoot(root));
    };

    const setup = () => {
      // check what is already in the DOM
      scanRoots();

      // observe future changes
      const observer = new MutationObserver(() => {
        scanRoots();
      });

      if (document.body) {
        observer.observe(document.body, {
          childList: true,
          subtree: true,
        });
      }
    };

    if (document.readyState === "loading") {
      window.addEventListener("DOMContentLoaded", setup, { once: true });
    } else {
      setup();
    }
</script>